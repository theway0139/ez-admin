# 前端实时更新报警事件 - 调试指南

## 更新内容

### 1. 自动刷新频率提升
- **之前**: 每30秒刷新一次
- **现在**: 每5秒刷新一次

### 2. 新增功能
- ✅ 新报警事件弹窗提示
- ✅ 自动滚动到顶部
- ✅ 防止缓存参数 `_t`
- ✅ 控制台调试日志

### 3. 调试方法

#### 打开浏览器控制台
1. 访问报警事件管理页面
2. 按 F12 打开开发者工具
3. 切换到 Console（控制台）标签

#### 查看日志输出
你会看到类似的日志：
```
⏰ 定时刷新报警事件...
正在获取报警事件... {page: 1, page_size: 10, ...}
报警事件响应: {data: Array(10), total: 25, ...}
当前总数: 25, 之前总数: 25
```

#### 当有新报警时
```
⏰ 定时刷新报警事件...
正在获取报警事件... {page: 1, page_size: 10, ...}
报警事件响应: {data: Array(10), total: 26, ...}
当前总数: 26, 之前总数: 25
✅ 检测到 1 条新报警事件！
```

同时会弹出黄色警告提示：🚨 检测到 1 条新报警事件！

### 4. 验证步骤

1. **打开页面并查看控制台**
2. **等待后端检测**（10秒截图 或 30秒视频）
3. **观察控制台日志**：
   - 每5秒会打印 "⏰ 定时刷新报警事件..."
   - 每次都会打印当前总数和之前总数
4. **当后端创建新报警时**：
   - 控制台会打印 "✅ 检测到 X 条新报警事件！"
   - 页面会弹出黄色警告提示
   - 列表会自动更新

### 5. 如果还是看不到更新

#### 检查1：后端是否真的在创建报警事件
查看后端日志：
```bash
ssh root@172.16.160.100
tail -f /root/Dog2/admin/backend/nohup.out | grep "创建报警事件"
```

#### 检查2：API是否返回数据
在浏览器控制台执行：
```javascript
fetch('http://172.16.160.100:8003/api2/alarm-events?page=1&page_size=10')
  .then(r => r.json())
  .then(d => console.log('API返回:', d))
```

#### 检查3：前端是否在轮询
控制台应该每5秒打印一次 "⏰ 定时刷新报警事件..."
如果没有，说明定时器没启动。

#### 检查4：数据是否真的变化
观察控制台的 "当前总数" 和 "之前总数"
如果后端创建了报警，这个数字应该会增加。

### 6. 临时禁用调试日志

如果调试完成，想关闭控制台日志，可以注释掉这几行：
```javascript
// console.log('正在获取报警事件...', params)
// console.log('报警事件响应:', response.data)
// console.log(`当前总数: ${newTotal}, 之前总数: ${previousEventCount}`)
// console.log(`✅ 检测到 ${newCount} 条新报警事件！`)
// console.log('⏰ 定时刷新报警事件...')
```

## 完整流程

```
Django启动
  ↓
视频分析服务启动（5秒后）
  ↓
每10秒截图 → 检测 → 创建报警事件
每30秒录5秒视频 → 检测 → 创建报警事件
  ↓
前端每5秒刷新列表
  ↓
检测到新事件 → 弹窗提示 → 自动滚动
```

## 文件位置

- 前端文件：`frontend/src/views/AlarmEvents.vue`
- 后端服务：`backend/ops/video_analysis_service.py`
- 后端API：`backend/ops/api.py`

